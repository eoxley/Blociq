<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>BlocIQ Functions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Office.js -->
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
<script type="text/javascript">
// Register command handlers
Office.onReady(() => {
  try {
    Office.actions.associate("generateAIReply", generateAIReply);
    Office.actions.associate("showInboxTriage", showInboxTriage);
    console.log("BlocIQ functions registered");
  } catch (e) {
    console.error("Registration error", e);
  }
});

function generateAIReply(event) {
  try {
    Office.context.ui.displayDialogAsync(
      "https://www.blociq.co.uk/outlook-addin/ai-reply-modal.html",
      { height: 60, width: 60, displayInIframe: true },
      (result) => {
        if (result.status !== Office.AsyncResultStatus.Succeeded) {
          console.error("Dialog failed", result.error);
          event.completed();
          return;
        }
        const dialog = result.value;

        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
          try {
            const data = JSON.parse(arg.message || "{}");
            if (data.action === "insertReply" && typeof data.content === "string") {
              insertGeneratedReply(data.content);
              dialog.close();
            }
            if (data.action === "close") dialog.close();
            if (data.action === "error") console.error("Modal error:", data.message);
          } catch (e) { console.error("Dialog parse error", e); }
        });

        dialog.addEventHandler(Office.EventType.DialogEventReceived, (arg) => {
          console.warn("DialogEvent", arg);
        });
      }
    );
  } catch (e) {
    console.error("generateAIReply error", e);
  } finally {
    // Always complete
    event.completed();
  }
}

function showInboxTriage(event) {
  try {
    Office.context.ui.displayDialogAsync(
      "https://www.blociq.co.uk/outlook-addin/ai-triage-modal.html",
      { height: 70, width: 70, displayInIframe: true },
      (result) => {
        if (result.status !== Office.AsyncResultStatus.Succeeded) {
          console.error("Dialog failed", result.error);
          event.completed();
          return;
        }
        const dialog = result.value;

        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
          try {
            const data = JSON.parse(arg.message || "{}");
            if (data.action === "triageComplete") {
              console.log("Triage complete", data);
              dialog.close();
            }
            if (data.action === "close") dialog.close();
            if (data.action === "error") console.error("Modal error:", data.message);
          } catch (e) { console.error("Dialog parse error", e); }
        });

        dialog.addEventHandler(Office.EventType.DialogEventReceived, (arg) => {
          console.warn("DialogEvent", arg);
        });
      }
    );
  } catch (e) {
    console.error("showInboxTriage error", e);
  } finally {
    event.completed();
  }
}

function insertGeneratedReply(content) {
  try {
    // Works in both Read->Reply mode (compose) and compose scenarios
    Office.context.mailbox.item.body.setAsync(
      content,
      { coercionType: Office.CoercionType.Html },
      (res) => {
        if (res.status !== Office.AsyncResultStatus.Succeeded) {
          console.error("Insert failed", res.error);
        }
      }
    );
  } catch (e) {
    console.error("insertGeneratedReply error", e);
  }
}
</script>
</body>
</html>