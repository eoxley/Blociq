<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BlocIQ Reply Functions</title>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
    <script>
        // Initialize Office.js
        Office.onReady(() => {
            console.log('BlocIQ Reply Functions loaded successfully');
        });

        // Global function for generating BlocIQ replies
        window.generateBlocIQReply = async function(event) {
            try {
                console.log('üöÄ Starting BlocIQ reply generation...');
                
                // Get user email from Office context
                const userEmail = Office.context.mailbox.userProfile.emailAddress;
                console.log('üìß User email:', userEmail);

                // Get current email context for better AI responses
                const emailContext = await getCurrentEmailContext();
                console.log('üìã Email context:', emailContext);

                // Prepare request body
                const requestBody = {
                    prompt: "Generate a professional reply for this email",
                    contextType: 'outlook_reply',
                    is_outlook_addin: true,
                    emailContext: emailContext
                };

                console.log('üì§ Sending request to API...');

                // Call the BlocIQ API
                const response = await fetch('https://www.blociq.co.uk/api/ask-ai-outlook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Email': userEmail
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì• API response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API error:', errorText);
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('üì• API response data:', data);

                // Extract the reply text
                const replyText = data.response || data.message || data.answer || 'I apologize, but I couldn\'t generate a reply. Please try again.';
                
                // Insert the reply into the email body
                await Office.context.mailbox.item.body.setSelectedDataAsync(
                    replyText,
                    { 
                        coercionType: Office.CoercionType.Html,
                        asyncContext: 'BlocIQ Reply Insertion'
                    }
                );

                console.log('‚úÖ Reply inserted successfully');

            } catch (error) {
                console.error('‚ùå Error generating BlocIQ reply:', error);
                
                // Insert error message into email
                const errorMessage = `Error generating AI reply: ${error.message}. Please try again.`;
                await Office.context.mailbox.item.body.setSelectedDataAsync(
                    errorMessage,
                    { 
                        coercionType: Office.CoercionType.Text,
                        asyncContext: 'BlocIQ Error Message'
                    }
                );
            } finally {
                // Always complete the event
                if (event && event.completed) {
                    event.completed();
                }
            }
        };

        // Helper function to get current email context
        async function getCurrentEmailContext() {
            try {
                const item = Office.context.mailbox.item;
                if (!item) return null;

                const context = {
                    subject: item.subject || 'No subject',
                    itemId: item.itemId || null,
                    itemType: item.itemType || 'message',
                };

                // Get sender information
                if (item.from) {
                    context.from = {
                        email: item.from.emailAddress || 'Unknown',
                        name: item.from.displayName || 'Unknown sender'
                    };
                }

                // Get recipient information
                if (item.to && Array.isArray(item.to)) {
                    context.to = item.to.map(recipient => ({
                        email: recipient.emailAddress || recipient,
                        name: recipient.displayName || recipient
                    }));
                }

                // Get CC recipients if available
                if (item.cc && Array.isArray(item.cc)) {
                    context.cc = item.cc.map(recipient => ({
                        email: recipient.emailAddress || recipient,
                        name: recipient.displayName || recipient
                    }));
                }

                // Get email body if available
                if (item.body) {
                    try {
                        const bodyData = await new Promise((resolve, reject) => {
                            item.body.getAsync(Office.CoercionType.Text, (result) => {
                                if (result.status === Office.AsyncResultStatus.Succeeded) {
                                    resolve(result.value);
                                } else {
                                    reject(result.error);
                                }
                            });
                        });
                        context.body = bodyData;
                    } catch (bodyError) {
                        console.warn('Could not get email body:', bodyError);
                    }
                }

                return context;

            } catch (error) {
                console.error('Error getting email context:', error);
                return null;
            }
        }

        console.log('üìÅ BlocIQ functions.html loaded successfully');
    </script>
</body>
</html>
