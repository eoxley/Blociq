<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BlocIQ Unified Functions</title>
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
  <h3 style="font-family: sans-serif; color: #444;">BlocIQ Unified Functions Loaded ‚úÖ</h3>
  <p style="font-family: sans-serif; color: #666; font-size: 12px;">
    This page provides all BlocIQ Outlook add-in functions: Generate Reply, Triage Inbox, and Ask BlocIQ.
  </p>

  <script>
    // ========== SHARED UTILITIES ==========

    function showToastNotification(message) {
      try {
        Office.context.mailbox.item.notificationMessages.replaceAsync("blociq-toast", {
          type: "informationalMessage",
          message: message,
          icon: "icon1",
          persistent: false
        });
      } catch (error) {
        console.log("Toast notification:", message);
      }
    }

    function showProgressNotification(message) {
      try {
        Office.context.mailbox.item.notificationMessages.replaceAsync("blociq-progress", {
          type: "progressIndicator",
          message: message
        });
      } catch (error) {
        console.log("Progress notification:", message);
      }
    }

    // ========== 1. GENERATE REPLY FUNCTION ==========

    function generateBlocIQReply(event) {
      const userEmail = Office.context.mailbox.userProfile.emailAddress || "";
      console.log("BlocIQ Reply triggered for user:", userEmail);

      // Extract email context for better AI responses
      Promise.all([
        new Promise(resolve => {
          Office.context.mailbox.item.subject.getAsync((result) => {
            resolve(result.status === Office.AsyncResultStatus.Succeeded ? result.value : "");
          });
        }),
        new Promise(resolve => {
          Office.context.mailbox.item.body.getAsync(Office.CoercionType.Text, (result) => {
            resolve(result.status === Office.AsyncResultStatus.Succeeded ? result.value : "");
          });
        })
      ])
       .then(([subject, body]) => {
         console.log("Email context extracted:", { subject: subject?.substring(0, 50) });

         // Parse building/unit references from email content
         const emailContent = `${subject}\n\n${body}`;
         const building = extractBuildingReference(emailContent);
         const unit = extractUnitReference(emailContent);

         // Extract additional context
         const senderInfo = getSenderInfo();
         const recipientInfo = getRecipientInfo();

         // Create contextual question for AI
         const contextualQuestion = createContextualQuestion(subject, body, building, unit);

         return fetch("https://www.blociq.co.uk/api/ask-ai-outlook", {
           method: "POST",
           headers: {
             "Content-Type": "application/json",
           },
           body: JSON.stringify({
             message: contextualQuestion,
             email_context: {
               subject: subject,
               content: body,
               sender_email: senderInfo?.email,
               sender_name: senderInfo?.name,
               recipient_email: recipientInfo?.email,
               building_reference: building,
               unit_reference: unit,
               user_email: userEmail
             }
           })
         });
       })
       .then(response => response.json())
       .then(data => {
         if (data.success && data.result) {
           const formattedResponse = formatResponseForEmail(data.result);

           // Insert the formatted response into the email body
           Office.context.mailbox.item.body.setSelectedDataAsync(
             formattedResponse,
             { coercionType: Office.CoercionType.Html },
             (result) => {
               if (result.status === Office.AsyncResultStatus.Succeeded) {
                 showToastNotification("‚úÖ BlocIQ reply generated successfully!");
               } else {
                 showToastNotification("‚ùå Failed to insert reply. Please try again.");
               }
               event.completed();
             }
           );
         } else {
           showToastNotification("‚ùå Failed to generate reply. Please try again.");
           event.completed();
         }
       })
       .catch(error => {
         console.error("Error generating reply:", error);
         showToastNotification("‚ùå Error generating reply. Please check your connection.");
         event.completed();
       });
    }

    // Reply generation helper functions
    function extractBuildingReference(content) {
      const buildingPatterns = [
        /\b([A-Za-z\s]+(?:House|Court|Gardens?|Apartments?|Building|Block|Tower|Place|Square|Street|Road|Close|Way|Lane|Avenue|Drive))\b/gi,
        /\b(\d+\s+[A-Za-z\s]+(?:Street|Road|Close|Way|Lane|Avenue|Drive))\b/gi
      ];

      for (const pattern of buildingPatterns) {
        const match = content.match(pattern);
        if (match && match[0]) {
          return match[0].trim();
        }
      }
      return null;
    }

    function extractUnitReference(content) {
      const unitPatterns = [
        /\b(?:Flat|Apartment|Unit|Apt\.?)\s*(\d+[A-Za-z]?)\b/gi,
        /\b(\d+[A-Za-z]?)\s*(?:Flat|Apartment|Unit|Apt\.?)\b/gi
      ];

      for (const pattern of unitPatterns) {
        const match = content.match(pattern);
        if (match && match[0]) {
          return match[0].trim();
        }
      }
      return null;
    }

    function getSenderInfo() {
      try {
        const item = Office.context.mailbox.item;
        if (item.from && item.from.emailAddress) {
          return {
            email: item.from.emailAddress,
            name: item.from.displayName || item.from.emailAddress
          };
        }
      } catch (error) {
        console.warn("Could not get sender info:", error);
      }
      return { email: "unknown@example.com", name: "Unknown Sender" };
    }

    function getRecipientInfo() {
      try {
        const item = Office.context.mailbox.item;
        if (item.to && item.to.length > 0) {
          return {
            email: item.to[0].emailAddress,
            name: item.to[0].displayName || item.to[0].emailAddress
          };
        }
      } catch (error) {
        console.warn("Could not get recipient info:", error);
      }
      return { email: "unknown@example.com", name: "Property Management Team" };
    }

    function createContextualQuestion(subject, body, building, unit) {
      let context = "Please generate a professional property management email reply for this enquiry:\n\n";

      if (subject) {
        context += `Subject: ${subject}\n\n`;
      }

      if (body) {
        context += `Original Message:\n${body.substring(0, 1000)}\n\n`;
      }

      if (building || unit) {
        context += "Property Context:\n";
        if (building) context += `Building: ${building}\n`;
        if (unit) context += `Unit: ${unit}\n`;
        context += "\n";
      }

      context += "Please provide a contextual, professional response using available building data and industry knowledge.";

      return context;
    }

    function formatResponseForEmail(response) {
      let formatted = response
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');

      // Extract user's first name for personalized closing
      const userEmail = Office.context.mailbox.userProfile.emailAddress || "";
      const userFirstName = userEmail.split('@')[0].split('.')[0];
      const capitalizedName = userFirstName.charAt(0).toUpperCase() + userFirstName.slice(1);

      // Replace generic closings with personalized ones
      formatted = formatted.replace(/Kind regards,\s*Property Management Team/gi, `Kind regards,<br>${capitalizedName}`);
      formatted = formatted.replace(/Best regards,\s*Property Management Team/gi, `Best regards,<br>${capitalizedName}`);

      return formatted;
    }

    // ========== 2. TRIAGE INBOX FUNCTION ==========

    let triageProgress = {
      total: 0,
      processed: 0,
      created: 0,
      failed: 0
    };

    function triageInbox(event) {
      const userEmail = Office.context.mailbox.userProfile.emailAddress || "";
      console.log("BlocIQ Triage triggered for user:", userEmail);

      showProgressNotification("üîÑ Starting inbox triage...");

      // Get the user's inbox folder
      Office.context.mailbox.getCallbackTokenAsync({ isRest: true }, (tokenResult) => {
        if (tokenResult.status !== Office.AsyncResultStatus.Succeeded) {
          console.error("Failed to get callback token:", tokenResult.error);
          showToastNotification("‚ùå Failed to access mailbox. Please try again.");
          event.completed();
          return;
        }

        const token = tokenResult.value;

        // Use Microsoft Graph API to get inbox messages
        fetchInboxMessages(token, userEmail)
          .then(messages => {
            if (!messages || messages.length === 0) {
              showToastNotification("üì≠ No unread messages found in inbox.");
              event.completed();
              return;
            }

            triageProgress.total = messages.length;
            triageProgress.processed = 0;
            triageProgress.created = 0;
            triageProgress.failed = 0;

            showToastNotification(`üìã Found ${messages.length} unread messages to triage...`);

            // Process messages in batches
            return processMessagesInBatches(messages, userEmail);
          })
          .then(() => {
            const successRate = Math.round((triageProgress.created / triageProgress.total) * 100);
            showToastNotification(`‚úÖ Triage complete! Created ${triageProgress.created}/${triageProgress.total} items (${successRate}% success)`);
            event.completed();
          })
          .catch(error => {
            console.error("Error during triage:", error);
            showToastNotification("‚ùå Triage failed. Please try again.");
            event.completed();
          });
      });
    }

    async function fetchInboxMessages(token, userEmail) {
      const graphUrl = `https://graph.microsoft.com/v1.0/me/mailFolders/inbox/messages?$filter=isRead eq false&$select=id,subject,bodyPreview,from,receivedDateTime&$top=50`;

      const response = await fetch(graphUrl, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`Graph API error: ${response.status}`);
      }

      const data = await response.json();
      return data.value;
    }

    async function processMessagesInBatches(messages, userEmail) {
      const batchSize = 5;
      for (let i = 0; i < messages.length; i += batchSize) {
        const batch = messages.slice(i, i + batchSize);
        await Promise.all(batch.map(msg => processMessageForTriage(msg, userEmail)));

        // Update progress
        const progress = Math.min(i + batchSize, messages.length);
        showProgressNotification(`üîÑ Processed ${progress}/${messages.length} messages...`);
      }
    }

    async function processMessageForTriage(message, userEmail) {
      try {
        triageProgress.processed++;

        // Call triage API
        const response = await fetch('https://www.blociq.co.uk/api/inbox-triage', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            subject: message.subject || 'No subject',
            body: message.bodyPreview || '',
            from: message.from?.emailAddress?.address || 'unknown@example.com',
            received_date: message.receivedDateTime,
            user_email: userEmail,
            message_id: message.id
          })
        });

        const result = await response.json();

        if (result.success && result.action_item_created) {
          triageProgress.created++;
        } else {
          triageProgress.failed++;
        }
      } catch (error) {
        console.error(`Error processing message ${message.id}:`, error);
        triageProgress.failed++;
      }
    }

    // ========== 3. ASK BLOCIQ FUNCTION ==========

    function askBlocIQ(event) {
      console.log("Ask BlocIQ triggered");

      try {
        // Open the chat taskpane
        Office.ribbon.requestUpdate({
          tabs: [{
            id: "TabDefault",
            groups: [{
              id: "blocIQGroup",
              controls: [{
                id: "btnAskBlocIQ",
                enabled: true
              }]
            }]
          }]
        });

        // For now, show a notification that opens the chat interface
        showToastNotification("üí¨ Opening BlocIQ Chat... Please check your taskpane.");

        // Open chat taskpane URL
        const chatUrl = "https://www.blociq.co.uk/outlook-addin/chat/taskpane.html";

        // Try to open as taskpane if supported
        if (Office.addin && Office.addin.showAsTaskpane) {
          Office.addin.showAsTaskpane(chatUrl);
        } else {
          // Fallback: show notification with instructions
          showToastNotification("üí¨ BlocIQ Chat available. Please contact support for setup assistance.");
        }

        event.completed();
      } catch (error) {
        console.error("Error opening Ask BlocIQ:", error);
        showToastNotification("‚ùå Could not open chat interface. Please try again.");
        event.completed();
      }
    }

    // ========== OFFICE INITIALIZATION ==========

    Office.onReady(() => {
      console.log("üöÄ BlocIQ Unified Functions loaded successfully");
      console.log("Available functions: generateBlocIQReply, triageInbox, askBlocIQ");
    });
  </script>
</body>
</html>