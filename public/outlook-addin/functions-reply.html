<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BlocIQ Reply Functions</title>
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
  <script>
    /**
     * Generate contextual reply using BlocIQ AI and insert into compose window.
     * Triggered when the user clicks the "Generate Reply" button.
     */
    function generateBlocIQReply(event) {
      console.log('🤖 BlocIQ Reply: Starting AI reply generation...');

      try {
        const userEmail = Office.context.mailbox.userProfile.emailAddress;
        if (!userEmail) {
          console.error('❌ No user email available from Office context');
          event.completed();
          return;
        }

        // Build question
        const question = "Generate a professional property management email reply";

        // Call backend
        fetch("https://www.blociq.co.uk/api/ask-ai-outlook", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-User-Email": userEmail
          },
          body: JSON.stringify({
            question,
            contextType: "outlook_reply",
            is_outlook_addin: true
          })
        })
        .then(resp => resp.json())
        .then(data => {
          if (data.ok && data.answer) {
            Office.context.mailbox.item.body.setSelectedDataAsync(
              data.answer,
              { coercionType: Office.CoercionType.Html },
              () => event.completed()
            );
          } else {
            console.error("❌ AI reply failed:", data.error);
            event.completed();
          }
        })
        .catch(err => {
          console.error("❌ Fetch failed:", err);
          event.completed();
        });

      } catch (error) {
        console.error("❌ Error in generateBlocIQReply:", error);
        event.completed();
      }
    }

    // Modern registration
    Office.onReady(() => {
      Office.actions.associate("generateBlocIQReply", generateBlocIQReply);
      console.log("✅ Registered generateBlocIQReply with Office.actions");
    });

    // Legacy fallback
    window.generateBlocIQReply = generateBlocIQReply;
  </script>
</body>
</html>
