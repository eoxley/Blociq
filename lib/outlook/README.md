# Outlook Integration - Compliance Reminders

This directory contains functions for integrating with Microsoft Outlook to create and manage compliance reminders as calendar events.

## createComplianceReminder.ts

### Overview

The `createComplianceReminder` function creates Outlook calendar events for compliance asset due dates with multiple reminder intervals. Since Outlook only supports one reminder per event, this function creates separate events for 90-day, 60-day, and 30-day reminders.

### Functions

#### `createComplianceReminder(params)`

**Purpose**: Create multiple Outlook calendar events for compliance reminders (90, 60, and 30 days before due date).

**Parameters**:
```typescript
{
  buildingName: string;           // Name of the building
  assetName: string;              // Name of the compliance asset
  nextDueDate: string;            // Due date in ISO format (YYYY-MM-DD)
  outlookAccessToken: string;     // Microsoft Graph access token
  buildingId?: number;            // Optional: Building ID for metadata storage
  complianceAssetId?: string;     // Optional: Compliance asset ID for metadata storage
  userId?: string;                // Optional: User ID for metadata storage
}
```

**Returns**: `Promise<ComplianceReminderResponse>`

**Strategy**: Creates 3 separate all-day events for 90, 60, and 30-day reminders.

#### `createSingleComplianceReminder(params)`

**Purpose**: Create a single 30-day reminder event (simpler approach).

**Parameters**: Same as `createComplianceReminder`

**Returns**: `Promise<ComplianceReminderResponse>`

**Strategy**: Creates 1 all-day event 30 days before the due date.

#### `updateComplianceReminder(params)`

**Purpose**: Update an existing compliance reminder event.

**Parameters**:
```typescript
{
  eventId: string;                // Outlook event ID
  buildingName: string;           // Updated building name
  assetName: string;              // Updated asset name
  nextDueDate: string;            // Updated due date
  outlookAccessToken: string;     // Microsoft Graph access token
}
```

**Returns**: `Promise<ComplianceReminderResponse>`

#### `deleteComplianceReminder(params)`

**Purpose**: Delete a compliance reminder event.

**Parameters**:
```typescript
{
  eventId: string;                // Outlook event ID
  outlookAccessToken: string;     // Microsoft Graph access token
}
```

**Returns**: `Promise<ComplianceReminderResponse>`

### Response Interface

```typescript
interface ComplianceReminderResponse {
  success: boolean;
  eventId?: string;
  message: string;
  error?: string;
  reminderType?: 'single' | 'multiple';
  eventsCreated?: number;
}
```

### Outlook Reminder Strategy

| Option | Description | Best For |
|--------|-------------|----------|
| ‚úÖ **Multiple Events** | Creates 3 separate events (90/60/30 days) | Full reliability, maximum coverage |
| üîÅ **Single Event** | Creates 1 event (30 days before) | Simple MVP, less calendar clutter |
| üß† **Hybrid Approach** | Use single for most, multiple for critical | Balanced approach |

### Event Details

#### Event Structure
- **Subject**: `[Compliance Reminder] {Type} - {AssetName} due at {BuildingName}`
- **Type**: All-day event
- **Importance**: High
- **Show As**: Busy
- **Categories**: `['Compliance', 'BlocIQ', '{ReminderType}']`
- **Time Zone**: Europe/London

#### Event Body Content
```html
<div style="font-family: Arial, sans-serif; max-width: 600px;">
  <h2 style="color: #d32f2f;">üö® Compliance Reminder</h2>
  <p><strong>Asset:</strong> {AssetName}</p>
  <p><strong>Building:</strong> {BuildingName}</p>
  <p><strong>Due Date:</strong> {FormattedDueDate}</p>
  <p><strong>Reminder Type:</strong> {ReminderType} reminder</p>
  <hr style="border: 1px solid #e0e0e0; margin: 20px 0;">
  <p style="color: #666; font-size: 14px;">
    This is a compliance reminder generated by BlocIQ.
    Please ensure this compliance requirement is addressed before the due date.
  </p>
  <p style="color: #666; font-size: 12px;">
    Generated on {CurrentDate}
  </p>
</div>
```

### Usage Examples

#### Basic Usage - Multiple Reminders

```typescript
import { createComplianceReminder } from '@/lib/outlook/createComplianceReminder';

const result = await createComplianceReminder({
  buildingName: 'Ashwood Court',
  assetName: 'Electrical Installation Condition Report',
  nextDueDate: '2025-06-15',
  outlookAccessToken: 'your-access-token-here',
  buildingId: 123,
  complianceAssetId: 'eicr-certificate',
  userId: 'user-123'
});

if (result.success) {
  console.log(`‚úÖ Created ${result.eventsCreated} reminder(s): ${result.message}`);
} else {
  console.error(`‚ùå Failed: ${result.error}`);
}
```

#### Simple Usage - Single Reminder

```typescript
import { createSingleComplianceReminder } from '@/lib/outlook/createComplianceReminder';

const result = await createSingleComplianceReminder({
  buildingName: 'Ashwood Court',
  assetName: 'Fire Safety Assessment',
  nextDueDate: '2025-03-20',
  outlookAccessToken: 'your-access-token-here'
});

if (result.success) {
  console.log(`‚úÖ Created reminder: ${result.eventId}`);
} else {
  console.error(`‚ùå Failed: ${result.error}`);
}
```

#### Update Existing Reminder

```typescript
import { updateComplianceReminder } from '@/lib/outlook/createComplianceReminder';

const result = await updateComplianceReminder({
  eventId: 'existing-event-id',
  buildingName: 'Ashwood Court',
  assetName: 'Gas Safety Certificate',
  nextDueDate: '2025-05-12',
  outlookAccessToken: 'your-access-token-here'
});

if (result.success) {
  console.log('‚úÖ Updated reminder successfully');
} else {
  console.error(`‚ùå Failed: ${result.error}`);
}
```

#### Delete Reminder

```typescript
import { deleteComplianceReminder } from '@/lib/outlook/createComplianceReminder';

const result = await deleteComplianceReminder({
  eventId: 'event-id-to-delete',
  outlookAccessToken: 'your-access-token-here'
});

if (result.success) {
  console.log('‚úÖ Deleted reminder successfully');
} else {
  console.error(`‚ùå Failed: ${result.error}`);
}
```

### Integration with Compliance System

#### After Document Upload

```typescript
import { createComplianceReminder } from '@/lib/outlook/createComplianceReminder';
import { getValidAccessToken } from '@/lib/outlookAuth';

// After successful document upload and AI extraction
const handleComplianceReminder = async (extractionResult: any) => {
  try {
    // Get valid Outlook access token
    const accessToken = await getValidAccessToken();
    
    if (!accessToken) {
      console.warn('‚ö†Ô∏è No Outlook connection available');
      return;
    }

    // Create reminders
    const reminderResult = await createComplianceReminder({
      buildingName: extractionResult.buildingName,
      assetName: extractionResult.assetName,
      nextDueDate: extractionResult.nextDueDate,
      outlookAccessToken: accessToken,
      buildingId: extractionResult.buildingId,
      complianceAssetId: extractionResult.complianceAssetId,
      userId: extractionResult.userId
    });

    if (reminderResult.success) {
      console.log(`‚úÖ Created ${reminderResult.eventsCreated} compliance reminders`);
    } else {
      console.error('‚ùå Failed to create reminders:', reminderResult.error);
    }
  } catch (error) {
    console.error('‚ùå Error creating compliance reminder:', error);
  }
};
```

#### Batch Processing

```typescript
import { createSingleComplianceReminder } from '@/lib/outlook/createComplianceReminder';
import { getValidAccessToken } from '@/lib/outlookAuth';

const createRemindersForBuilding = async (buildingId: number, complianceAssets: any[]) => {
  const accessToken = await getValidAccessToken();
  
  if (!accessToken) {
    console.warn('‚ö†Ô∏è No Outlook connection available');
    return;
  }

  const results = [];
  
  for (const asset of complianceAssets) {
    if (asset.next_due_date) {
      const result = await createSingleComplianceReminder({
        buildingName: asset.building_name,
        assetName: asset.asset_name,
        nextDueDate: asset.next_due_date,
        outlookAccessToken: accessToken,
        buildingId: buildingId,
        complianceAssetId: asset.id,
        userId: asset.user_id
      });
      
      results.push({
        assetId: asset.id,
        success: result.success,
        message: result.message
      });
    }
  }

  return results;
};
```

### Error Handling

#### Common Error Scenarios

1. **Invalid Date Format**
   ```typescript
   // Error: nextDueDate must be in ISO format (YYYY-MM-DD)
   // Solution: Ensure date is in correct format
   const nextDueDate = '2025-06-15'; // ‚úÖ Correct
   const nextDueDate = '15/06/2025'; // ‚ùå Wrong format
   ```

2. **Missing Access Token**
   ```typescript
   // Error: Missing required parameters: outlookAccessToken
   // Solution: Ensure user has connected Outlook account
   const accessToken = await getValidAccessToken();
   if (!accessToken) {
     // Handle no Outlook connection
   }
   ```

3. **Past Reminder Dates**
   ```typescript
   // Error: All reminder dates are in the past
   // Solution: Check if due date is far enough in the future
   const dueDate = new Date(nextDueDate);
   const minReminderDate = new Date(dueDate.getTime() - 90 * 24 * 60 * 60 * 1000);
   if (minReminderDate <= new Date()) {
     // Handle past due dates
   }
   ```

4. **Graph API Errors**
   ```typescript
   // Error: Graph API error: 401 Unauthorized
   // Solution: Refresh access token or re-authenticate
   // Error: Graph API error: 403 Forbidden
   // Solution: Check calendar permissions
   ```

### Metadata Storage

The function optionally stores reminder metadata in Supabase for tracking and updates:

```sql
-- compliance_reminders table (optional)
CREATE TABLE compliance_reminders (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  building_id INTEGER REFERENCES buildings(id),
  compliance_asset_id TEXT REFERENCES compliance_assets(id),
  user_id TEXT REFERENCES users(id),
  outlook_event_id TEXT NOT NULL,
  reminder_date DATE NOT NULL,
  reminder_type TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Performance Considerations

- **Rate Limiting**: Microsoft Graph API has rate limits (10,000 requests per 10 minutes)
- **Batch Operations**: Consider batching multiple reminder creations
- **Error Recovery**: Individual reminder failures don't stop the entire operation
- **Caching**: Cache access tokens to reduce authentication overhead

### Security

- **Token Management**: Access tokens are validated and refreshed automatically
- **Input Validation**: All inputs are validated before API calls
- **Error Logging**: Sensitive information is not logged
- **Permission Scopes**: Requires `Calendars.ReadWrite` permission

### Testing

```typescript
// Test with valid data
const testResult = await createSingleComplianceReminder({
  buildingName: 'Test Building',
  assetName: 'Test Asset',
  nextDueDate: '2025-12-31',
  outlookAccessToken: 'test-token'
});

// Test error handling
try {
  await createComplianceReminder({
    buildingName: '',
    assetName: 'Test',
    nextDueDate: 'invalid-date',
    outlookAccessToken: 'test-token'
  });
} catch (error) {
  console.log('Expected error:', error.message);
}
```

### Future Enhancements

1. **Smart Reminder Timing**: Adjust reminder intervals based on asset type
2. **Recurring Reminders**: Support for recurring compliance requirements
3. **Team Notifications**: Add team members to reminder events
4. **Integration with Tasks**: Create Outlook tasks alongside calendar events
5. **Reminder Analytics**: Track reminder effectiveness and user engagement
6. **Custom Reminder Templates**: Allow customization of reminder content
7. **Bulk Operations**: Optimize for creating many reminders at once
8. **Reminder History**: Track all reminder interactions and updates 