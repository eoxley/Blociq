# CSV Export + PDF Download Support for BlocIQ

## Overview

BlocIQ now supports comprehensive CSV export functionality and enhanced PDF download capabilities for professional document management and recipient tracking.

## üìä CSV Export Features

### 1. Recipient Export

**Component:** `RecipientSelector.tsx`

**Features:**
- Export selected recipients to CSV format
- Includes: Name, Email, Unit, Type, Building
- Automatic filename with timestamp
- Filter and search before export

**Usage:**
```typescript
import { exportRecipientsToCSV } from '@/lib/csvExport';

// Export selected recipients
exportRecipientsToCSV(selectedRecipients, 'recipients');
```

**CSV Format:**
```csv
Name,Email,Unit,Type,Building
Jane Doe,jane@email.com,Flat 3,leaseholder,Ashwood House
John Smith,john@email.com,Flat 4,leaseholder,Ashwood House
```

### 2. Communications Log Export

**Component:** `app/communications/log/page.tsx`

**Features:**
- Export all communications history
- Includes: Recipient, Subject, Template, Building, Date, Status
- Filtered export based on current search/filters
- Professional formatting with dates

**CSV Format:**
```csv
Recipient Email,Subject,Template,Building,Sent By,Sent Date,Status
jane@email.com,Service Charge Notice,Service Charge Template,Ashwood House,Ellie Oxley,15/01/2024,sent
john@email.com,Welcome Letter,Welcome Template,Ashwood House,Ellie Oxley,14/01/2024,sent
```

### 3. Generated Documents Export

**Features:**
- Export all generated documents
- Includes: Template, Building, Generated By, Date, AI Generated
- Track document generation history

## üìÑ PDF Download Support

### 1. Enhanced PDF Conversion

**API Endpoint:** `/api/convert-pdf`

**Features:**
- Convert generated DOCX files to PDF
- Store PDFs in Supabase Storage
- Update database with PDF path
- Fallback to DOCX if conversion fails

**Request:**
```typescript
POST /api/convert-pdf
{
  "filePath": "generated/document_2024-01-15.docx"
}
```

**Response:**
```typescript
{
  "success": true,
  "pdfUrl": "https://.../document_2024-01-15.pdf",
  "pdfPath": "generated/document_2024-01-15.pdf",
  "filename": "document_2024-01-15.pdf"
}
```

### 2. Email Form PDF Support

**Component:** `SendEmailForm.tsx`

**Features:**
- File type selector (DOCX/PDF)
- Automatic PDF conversion
- Download both formats
- Email attachment support

**Workflow:**
1. Generate document (DOCX)
2. Select file type (DOCX/PDF)
3. Auto-convert to PDF if needed
4. Download or send via email

### 3. Template Generation PDF Support

**Component:** `app/communications/templates/[id]/page.tsx`

**Features:**
- Download as DOCX or PDF
- Automatic conversion
- Progress indicators
- Error handling with fallbacks

## üîß Technical Implementation

### CSV Export Utilities

**File:** `lib/csvExport.ts`

**Core Functions:**
```typescript
// Generic CSV export
exportToCSV(data: CSVExportData[], columns: CSVColumn[], filename: string)

// Specific exports
exportRecipientsToCSV(recipients: any[], filename: string)
exportCommunicationsToCSV(communications: any[], filename: string)
exportDocumentsToCSV(documents: any[], filename: string)
```

**Features:**
- Proper CSV escaping (quotes, commas)
- Automatic timestamp in filename
- UTF-8 encoding
- Error handling

### PDF Conversion

**External Service:** CloudConvert API
**Fallback:** DOCX download with user notification

**Storage:**
- PDFs stored in `generated/` bucket
- Database updated with `pdf_path`
- Public URLs for download

## üìã Usage Examples

### 1. Export Recipients

```typescript
// In RecipientSelector component
const handleExport = () => {
  if (selectedRecipients.length === 0) {
    toast.error('Please select recipients to export');
    return;
  }
  
  exportRecipientsToCSV(selectedRecipients, 'ashwood_house_recipients');
  toast.success('Recipients exported successfully');
};
```

### 2. Download PDF

```typescript
// In template generation
const handleDownloadPDF = async () => {
  setConvertingPdf(true);
  
  try {
    const response = await fetch('/api/convert-pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filePath: generatedFilePath })
    });
    
    const result = await response.json();
    
    if (result.success) {
      window.open(result.pdfUrl, '_blank');
      toast.success('PDF downloaded successfully');
    }
  } catch (error) {
    toast.error('PDF conversion failed');
  } finally {
    setConvertingPdf(false);
  }
};
```

### 3. Export Communications Log

```typescript
// In communications log page
const handleExportLog = () => {
  const filteredData = communications.filter(/* filters */);
  exportCommunicationsToCSV(filteredData, 'communications_log');
  toast.success('Communications log exported');
};
```

## üéØ Benefits

### CSV Export Benefits:
1. **Record Keeping** - Export recipient lists for external systems
2. **Data Analysis** - Import into Excel/Google Sheets for analysis
3. **Backup** - Create backups of recipient data
4. **Compliance** - Maintain records for regulatory requirements
5. **Integration** - Import into other property management systems

### PDF Download Benefits:
1. **Professional Format** - Clean, print-ready documents
2. **Universal Compatibility** - Works on all devices and platforms
3. **Email Friendly** - Smaller file sizes for email attachments
4. **Print Quality** - High-quality output for physical mailouts
5. **Archive Format** - Long-term document storage

## üîÑ Workflow Integration

### Complete Document Workflow:
1. **Generate Document** ‚Üí Template fills with data
2. **Select Recipients** ‚Üí Choose from building leaseholders
3. **Export Recipients** ‚Üí CSV for record keeping
4. **Convert to PDF** ‚Üí Professional format
5. **Send via Email** ‚Üí PDF attachment
6. **Log Communication** ‚Üí Track in database
7. **Export Log** ‚Üí CSV for reporting

### Email Workflow:
1. **Generate DOCX** ‚Üí Template processing
2. **Convert to PDF** ‚Üí Professional format
3. **Select Recipients** ‚Üí From building data
4. **Send Email** ‚Üí PDF attachment
5. **Log Activity** ‚Üí Database tracking

## üöÄ Future Enhancements

### Planned Features:
1. **Bulk Email Export** - Export multiple recipients at once
2. **Custom CSV Formats** - User-defined column layouts
3. **Scheduled Exports** - Automated CSV generation
4. **PDF Templates** - Custom PDF styling
5. **Batch PDF Conversion** - Convert multiple documents
6. **Email Analytics** - Track open rates, clicks
7. **Advanced Filtering** - More sophisticated export filters

### Technical Improvements:
1. **Offline PDF Conversion** - Server-side LibreOffice
2. **PDF Compression** - Smaller file sizes
3. **Watermarking** - Add company branding
4. **Digital Signatures** - Secure document signing
5. **Version Control** - Track document versions

## üìä Database Schema Updates

### communications_sent Table:
```sql
-- Added pdf_path column for PDF storage
ALTER TABLE communications_sent 
ADD COLUMN pdf_path VARCHAR(500);

-- Index for PDF queries
CREATE INDEX idx_communications_sent_pdf_path 
ON communications_sent(pdf_path);
```

### generated_documents Table:
```sql
-- PDF path already exists
-- Used for storing PDF file paths
pdf_path VARCHAR(500)
```

## üîê Security Considerations

1. **File Access** - PDFs stored with public read access
2. **Data Privacy** - CSV exports include only necessary data
3. **Rate Limiting** - PDF conversion API rate limits
4. **Error Handling** - Graceful fallbacks for failed conversions
5. **Audit Trail** - All exports logged in database

The CSV Export and PDF Download features provide BlocIQ with professional document management capabilities, enabling property managers to maintain comprehensive records and deliver high-quality communications to leaseholders. 